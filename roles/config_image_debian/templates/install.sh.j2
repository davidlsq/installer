#!/bin/bash

set -e -o pipefail

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

if [ ! -f /install/install.done ]; then
  apt-get update
  apt-get install -y python3 python3-pip python3-venv python-is-python3
  python3 -m venv /install/ansible-venv
  source /install/ansible-venv/bin/activate
  python3 -m pip install ansible
  ANSIBLE_HOSTS="$(ls "/install/host_vars" | tr '\n' ',')"
  ansible-playbook -i "$ANSIBLE_HOSTS" -c local "/install/install.yml"
  touch /install/install.done
fi
