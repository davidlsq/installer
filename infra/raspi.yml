---

- name: Base
  hosts: raspi
  gather_facts: false
  become: true
  tags: base
  roles:
    - role: systemctl
      tags: systemctl
    - role: ssh
      tags: ssh
      ssh_port: '{{ raspi_ssh_port }}'
      ssh_key: raspi/ssh_keys_host
      ssh_key_pub: raspi/ssh_keys_host.pub
    - role: user
      tags: user
      user_name: root
      user_password: '{{ raspi_hash_user_root }}'
      user_shell: /bin/zsh
    - role: user
      tags: user
      user_id: '{{ user_regular_id }}'
      user_name: '{{ user_regular_name }}'
      user_password: '{{ raspi_hash_user_regular }}'
      user_key_pub: 'raspi/ssh_keys_{{ user_regular_name }}.pub'
      user_shell: /bin/zsh
      user_sudo_group: yes-no-password
    - role: ohmyzsh
      ohmyzsh_user_name: root
    - role: ohmyzsh
      ohmyzsh_user_name: '{{ user_regular_name }}'

- name: Data Disks
  hosts: raspi
  gather_facts: false
  become: true
  tags: data
  roles:
    - role: lvm_vg
      vg_name: data
      vg_disks:
        - '{{ raspi_disk_1 }}'

- name: CheckMK Agent
  hosts: raspi
  gather_facts: false
  become: true
  tags: checkmk_agent
  roles:
    - role: checkmk_agent
      checkmk_site: '{{ server_checkmk_site }}'
      checkmk_address: '{{ server_network_local_ip_address }}'
      checkmk_automation_password: '{{ server_password_checkmk_automation }}'
      checkmk_agent_name: server
      checkmk_agent_register: false

- name: Installer
  hosts: raspi
  gather_facts: false
  become: true
  tags: installer
  roles:
    - role: installer
      installer_directory: infra
      installer_host: raspi
    - role: user
      tags: user
      user_id: '{{ user_github_id }}'
      user_name: '{{ user_github_name }}'
      user_password: '{{ raspi_hash_user_github }}'
      user_key_pub: 'raspi/ssh_keys_{{ user_github_name }}.pub'
      user_sudo_group: false
      user_sudo_commands:
        - /usr/lib/installer/run.sh *

- name: Pi Hole
  hosts: raspi
  gather_facts: false
  become: true
  tags: pihole
  roles:
    - role: lvm_lv
      tags: data
      vg_name: data
      lv_name: pihole
      lv_size: 10G
      lv_opts: --type linear
    - role: pihole
      pihole_var: /mnt/data/pihole
      pihole_user_id: 1010
      pihole_password: '{{ raspi_hash_pihole }}'
      pihole_interface: '{{ raspi_network_interface }}'
      pihole_dns_1: '{{ network_public_dns_1 }}'
      pihole_dns_2: '{{ network_public_dns_2 }}'

- name: Local Network
  hosts: raspi
  gather_facts: false
  become: true
  tags: base
  roles:
    - role: network
      tags: network
      network_interface: '{{ raspi_network_interface }}'
      network_dns: ['{{ network_local_dns }}']
